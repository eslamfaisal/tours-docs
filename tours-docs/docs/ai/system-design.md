# System Design

MCP-enabled architecture for documentation-driven AI interactions.

---

## Architecture Overview

```mermaid
graph TD
    subgraph "User Layer"
        A[Developer Request]
        B[Chat Assistant]
    end

    subgraph "MCP Layer"
        C[MCP Client]
        D[docs_search]
        E[docs_read]
        F[docs_list]
        G[requirements_extract]
        H[api_validate]
        I[context_build]
    end

    subgraph "Documentation Layer"
        J[(MkDocs Repository)]
        K[Search Index]
        L[Metadata Cache]
    end

    subgraph "Generation Layer"
        M[Context Aggregator]
        N[LLM Engine]
        O[Validation Gate]
        P[Citation Generator]
    end

    A --> C
    B --> C
    C --> D & E & F & G & H & I
    D --> K
    E --> J
    F --> L
    G & H & I --> J
    D & E & F & G & H & I --> M
    M --> N
    N --> O
    O --> P
    P --> Q[Cited Output]
```

---

## Components

### MCP Client

The orchestration layer that routes requests to appropriate tools:

| Responsibility | Description |
|----------------|-------------|
| Tool Selection | Determines which MCP tools to invoke based on request |
| Parallel Execution | Runs independent tool calls concurrently |
| Response Aggregation | Combines tool outputs into unified context |
| Error Handling | Manages tool failures and gap detection |

### Documentation Layer

```mermaid
graph LR
    A[Markdown Files] --> B[MkDocs Build]
    B --> C[HTML Site]
    B --> D[Search Index]
    A --> E[Direct Access]
    E --> F[MCP Tools]
```

| Component | Purpose |
|-----------|---------|
| MkDocs Repository | Source markdown files in `docs/` |
| Search Index | Lunr.js index generated by MkDocs |
| Metadata Cache | Pre-computed file metadata and headings |

### Context Aggregator

Builds comprehensive context maps for generation:

```yaml
context_map:
  task: "Implement booking confirmation email"
  sections:
    - requirements:
        source: docs/requirements/functional.md
        items: [FR-BOOK-005, FR-EMAIL-001]
    - api:
        source: docs/api/bookings.md
        endpoints: [GET /bookings/{id}]
    - localization:
        source: docs/frontend/i18n.md
        keys: [email.booking.confirmed.*]
```

### Validation Gate

Pre-output compliance checks:

```mermaid
graph LR
    A[Generated Output] --> B{Complete?}
    B -->|No| C[Request More Context]
    B -->|Yes| D{Compliant?}
    D -->|No| E[Flag Violations]
    D -->|Yes| F{Cited?}
    F -->|No| G[Add Citations]
    F -->|Yes| H[Approved Output]
```

---

## Request Flow

### Standard Generation Request

```mermaid
sequenceDiagram
    participant U as User
    participant M as MCP Client
    participant D as docs_search
    participant R as docs_read
    participant C as context_build
    participant L as LLM
    participant V as Validator

    U->>M: "Implement trip search API"
    M->>D: Search "trip search API"
    D-->>M: [api/trips.md, backend/modules.md]
    M->>R: Read api/trips.md
    M->>R: Read backend/modules.md
    R-->>M: File contents
    M->>C: Build context for "trip search"
    C-->>M: Requirements + Constraints
    M->>L: Generate with context
    L-->>V: Draft implementation
    V->>V: Validate completeness
    V->>V: Check compliance
    V->>V: Verify citations
    V-->>U: Approved output with references
```

### Gap Detection Flow

```mermaid
sequenceDiagram
    participant U as User
    participant M as MCP Client
    participant D as docs_search
    participant V as Validator

    U->>M: "Implement payment webhooks"
    M->>D: Search "payment webhooks"
    D-->>M: No results
    M->>V: Check for gap
    V-->>U: DOCUMENTATION_GAP: Missing payment webhook specification
```

---

## Integration Points

### Frontend Chat Widget

```typescript
// React component integration
const ChatWidget = () => {
  const sendMessage = async (message: string) => {
    const response = await fetch('/api/chat', {
      method: 'POST',
      body: JSON.stringify({
        message,
        context: { useMCP: true }
      })
    });
    // Response includes citations from docs
  };
};
```

### Backend Chat Service

```java
@Service
public class ChatService {
    
    private final MCPClient mcpClient;
    private final LLMProvider llmProvider;
    
    public ChatResponse process(ChatRequest request) {
        // 1. Build context via MCP
        Context ctx = mcpClient.buildContext(request.getMessage());
        
        // 2. Generate with LLM
        String response = llmProvider.generate(ctx);
        
        // 3. Validate and cite
        return validator.validateAndCite(response, ctx);
    }
}
```

---

## Multilingual Support

All documentation operations support three languages:

| Language | Code | Index | RTL Support |
|----------|------|-------|-------------|
| English | `en` | Primary | No |
| Spanish | `es` | Secondary | No |
| Arabic | `ar` | Secondary | Yes |

Language selection follows this priority:

1. Explicit `language` parameter
2. User's `Accept-Language` header
3. Default to English
